<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fluttrim Docs Viewer</title>
    <meta name="description" content="Fluttrim documentation viewer." />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar container">
      <div class="brand">
        <img src="../assets/logo-cropped.png" alt="Fluttrim logo" class="brand-mark" />
        <span id="brand-title">Fluttrim Docs</span>
      </div>
      <nav class="nav-links">
        <a id="nav-home" href="/">Home</a>
        <a id="nav-docs" href="/docs/" class="active">Docs</a>
      </nav>
      <div class="lang-switch" role="group" aria-label="Language">
        <button data-lang-btn="en" class="is-active">EN</button>
        <button data-lang-btn="ko">KO</button>
      </div>
    </header>

    <main class="container docs-layout">
      <article class="panel doc-panel">
        <h1 id="doc-title">Loading...</h1>
        <div class="doc-meta">
          <a id="source-link" class="btn" href="#" target="_blank" rel="noopener noreferrer">Source</a>
          <a id="all-docs-link" class="btn" href="/docs/">All docs</a>
        </div>
        <p id="language-fallback" class="fallback-message" hidden></p>
        <div id="doc-body" class="doc-body"></div>
      </article>

      <aside class="panel toc-panel">
        <h2 id="toc-title">On this page</h2>
        <nav id="toc-nav" class="toc-nav"></nav>
      </aside>

      <p id="viewer-notice" class="notice">If rendering fails, use Source to open the original markdown.</p>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="./docs.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const slug = params.get("doc");

      const titleNode = document.getElementById("doc-title");
      const bodyNode = document.getElementById("doc-body");
      const sourceNode = document.getElementById("source-link");
      const fallbackNode = document.getElementById("language-fallback");
      const tocNode = document.getElementById("toc-nav");

      function slugifyHeading(text) {
        return (text || "section")
          .toString()
          .trim()
          .toLowerCase()
          .replace(/[^\w\-\s가-힣]/g, "")
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-");
      }

      function assignHeadingIds() {
        const headings = bodyNode.querySelectorAll("h1, h2, h3");
        const used = new Set();
        headings.forEach((heading, idx) => {
          let id = slugifyHeading(heading.textContent || `section-${idx + 1}`);
          if (!id) id = `section-${idx + 1}`;
          let suffix = 1;
          let candidate = id;
          while (used.has(candidate) || document.getElementById(candidate)) {
            suffix += 1;
            candidate = `${id}-${suffix}`;
          }
          used.add(candidate);
          heading.id = candidate;
        });
        return Array.from(headings);
      }

      function buildToc(i18n) {
        tocNode.innerHTML = "";
        const headings = assignHeadingIds();
        if (headings.length === 0) {
          const empty = document.createElement("p");
          empty.className = "toc-empty";
          empty.textContent = i18n.emptyToc;
          tocNode.appendChild(empty);
          return;
        }

        const list = document.createElement("ul");
        list.className = "toc-list";
        headings.forEach((heading) => {
          const item = document.createElement("li");
          const level = Number(heading.tagName.substring(1));
          item.className = `toc-level-${level}`;

          const link = document.createElement("a");
          link.href = `#${heading.id}`;
          link.textContent = heading.textContent || heading.id;
          item.appendChild(link);
          list.appendChild(item);
        });
        tocNode.appendChild(list);
      }

      async function loadMarkdown(localizedDoc, language, i18n) {
        fallbackNode.hidden = true;
        const primaryPath = localizedDoc.filePath;
        const fallbackPath = localizedDoc.fallbackFilePath;

        async function fetchMarkdown(path) {
          if (!path) {
            throw new Error("missing path");
          }
          const response = await fetch(`./${path}`);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.text();
        }

        try {
          const markdown = await fetchMarkdown(primaryPath);
          bodyNode.innerHTML = window.marked.parse(markdown, { breaks: true });
        } catch (primaryError) {
          if (fallbackPath && fallbackPath !== primaryPath) {
            try {
              const fallbackMarkdown = await fetchMarkdown(fallbackPath);
              bodyNode.innerHTML = window.marked.parse(fallbackMarkdown, { breaks: true });
              fallbackNode.textContent = i18n.viewerFallback;
              fallbackNode.hidden = false;
            } catch (fallbackError) {
              bodyNode.innerHTML = `<p>${i18n.loadFailedPrefix} (${fallbackError.message}).</p>`;
            }
          } else {
            bodyNode.innerHTML = `<p>${i18n.loadFailedPrefix} (${primaryError.message}).</p>`;
          }
        }

        buildToc(i18n);
      }

      function setLanguage(language) {
        const lang = window.FluttrimDocs.setPreferredLanguage(language);
        const i18n = window.FluttrimDocs.getI18n(lang);

        document.getElementById("brand-title").textContent = i18n.docsTitle;
        document.getElementById("nav-home").textContent = i18n.home;
        document.getElementById("nav-docs").textContent = i18n.docs;
        document.getElementById("toc-title").textContent = i18n.tocTitle;
        document.getElementById("viewer-notice").textContent = i18n.viewerNotice;
        document.getElementById("all-docs-link").textContent = i18n.allDocs;

        document.querySelectorAll("[data-lang-btn]").forEach((button) => {
          button.classList.toggle("is-active", button.getAttribute("data-lang-btn") === lang);
        });

        const doc = window.FluttrimDocs.getDocBySlug(slug);
        if (!doc) {
          titleNode.textContent = i18n.notFoundTitle;
          bodyNode.innerHTML = `<p>${i18n.notFoundBody}</p>`;
          sourceNode.textContent = i18n.source;
          sourceNode.href = "https://github.com/curogom/fluttrim";
          buildToc(i18n);
          return;
        }

        const localizedDoc = window.FluttrimDocs.getLocalizedDoc(doc, lang);
        titleNode.textContent = localizedDoc.titleText;
        document.title = `${localizedDoc.titleText} | ${i18n.docsTitle}`;
        sourceNode.href = doc.source;
        sourceNode.textContent = i18n.source;
        document.getElementById("all-docs-link").href = window.FluttrimDocs.withLang("/docs/", lang);

        const next = new URL(window.location.href);
        next.searchParams.set("lang", lang);
        if (next.toString() !== window.location.href) {
          window.history.replaceState({}, "", `${next.pathname}${next.search}`);
        }

        loadMarkdown(localizedDoc, lang, i18n);
      }

      document.querySelectorAll("[data-lang-btn]").forEach((button) => {
        button.addEventListener("click", () => {
          setLanguage(button.getAttribute("data-lang-btn"));
        });
      });

      setLanguage(window.FluttrimDocs.getPreferredLanguage(params.get("lang")));
    </script>
  </body>
</html>
